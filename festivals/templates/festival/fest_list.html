{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/static/css/navigation.css">
    <link rel="stylesheet" type="text/css" href="/static/css/footer.css">
    <link rel="stylesheet" type="text/css" href="/static/css/fonts.css">
    <link rel="stylesheet" type="text/css" href="/static/css/components.css">
    {% comment %} <link rel="stylesheet" type="text/css" href="/static/css/main.css"> {% endcomment %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>Document</title>
    <style>
      * {
        margin:0; padding: 0; box-sizing: border-box; font-family: "Poppins", "Noto Sans KR", sans-serif;
      }
      ul, li {list-style: none;}
      a {text-decoration: none; color: inherit;}

      #wrap {
        flex: 1;
      }

      #banner_blur {
        height: 400px;
                  
        justify-content: center;    
        align-items: center;       
      }

      #banner_blur h1 {
        display: inline-block;
        width: 60%;
        margin: 6% 20% 1% 20%;
      }

      #searchBlocks {
        display: flex;
        margin: 0 auto;
        justify-content: space-between;
        align-items: stretch;
        background-color: #fff;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 10px;
        gap: 20px;
        width: 60%;
        height: 145px;
        
      }

      .searchBlock {
        display: flex;
        flex-direction: column;
        /*gap: 8px;*/
      }


      .region {
        width: 15%;
        
      }

      .name {
        width: 35%;
      }

      .date {
        width: 35%;
        justify-content: space-between;
      
      }

      .button {
        width: 10%;
        display: flex;
        justify-content: flex-start;
      }

      .searchBlock h3 {
        font-size: 18px;
        /*margin-bottom: 8px;*/
        color: #333;
        min-height: 22px;
      }

      .region input {
        margin-top: auto; /* inputì„ ì•„ë˜ë¡œ ë°€ê¸° */
      }

      .name input {
        margin-top: auto; /* inputì„ ì•„ë˜ë¡œ ë°€ê¸° */
      }

      .searchBlock input[type="text"],
      .searchBlock input[type="date"] {
        padding: 10px 12px;
        font-size: 15px;
        border: 1px solid #ccc;
        border-radius: 6px;
        height: 45px;
        width: 100%;

      }

      .searchBlock button {
        background: linear-gradient(90deg, #ffb300 0%, #4fc3f7 100%);
      }

      .date .stardToEnd {
        display: flex;
        width: 90%;
        align-items: center;
        gap: 10px;
      }

      .date .stardToEnd > div {
        flex: 1;
      }

      .date label {
        font-size: 13px;
        margin-bottom: 5px;
        display: block;
      }

      .button button {
        margin-top: auto;
        padding: 12px;
        font-size: 17px;
        font-weight: 500;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .button button:hover {
        background-color: #0056b3;
      }

      @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap');

      .contents {
        width: 60%;
        margin: 0 auto; /* ì¤‘ì•™ ì •ë ¬ */
      }

      
      /* ë¦¬ìŠ¤íŠ¸ ë¶€ë¶„ */

      #festList {
        width: 100%;
        margin-bottom: 50px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 20px;
      }

      .festCard {
        width: calc(32% - 10px);
        min-height: 620px;
        display: flex;
        flex-direction: column;
        border-radius: 12px;
        position: relative;
        cursor: pointer;
        text-align: left;
        font-family: inherit;
        background: 
        linear-gradient(to bottom right, #fefae0, #e9f5ff),
        repeating-linear-gradient(135deg, rgba(255,255,255,0.05) 0 2px, transparent 2px 6px),
        repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0 2px, transparent 2px 6px);
        
        box-shadow: 0 6px 16px rgba(0,0,0,0.08);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }

      .festCard:hover {
        transform: translateY(-6px);
        box-shadow: 0 10px 24px rgba(0,0,0,0.15);
      }

      .festCard a img {
        width: 100%;
        height: 300px;
        object-fit: cover;
        border-bottom: 1px solid #e2d7c3;
      }

      .festCard::before {
        content: "Happening Now";
        position: absolute;
        top: 10px;
        left: 10px;
        background: #F66989;
        /*background: linear-gradient(45deg, #cc5c48, #e2905b);*/
        color: #fff;
        font-size: 12px;
        padding: 5px 7px;
        border-radius: 8px;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        z-index: 1;
      }




      /* ê³µí†µ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
      .festCard p {
        margin: 4px 12px;
        white-space: normal;
        overflow: visible;
        line-height: 1.6em;
      }

      .festCard p.title {
        font-size: 16px;
        font-weight: 700;
        color: #b35c1e;
        margin-top: 8px;
        margin-bottom: 6px;
      }

      .festCard p.rating {
        font-size: 14px;
        color: #e2a934;
        white-space: nowrap;
        margin-bottom: 8px;
      }

      
      .festCard p.date-info {
        font-size: 14px;
        color: #5a4632;
        background: rgba(243, 234, 204, 0.6);
        padding: 6px 10px;
        border-radius: 8px;
        padding-bottom: 8px;
      }      

      .festival-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 12px 20px 20px;
      }

      .festival-tags .tag,
      .tag {
        background-color: #E6F5FF;
        color: #4fc3f7;
        font-weight: bold;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 13px;
        cursor: default;
      }

      .rating-region {
        margin: 0 20px 10px;
        display: flex;
        justify-content: space-between;
      }

      .festival-rating {
        font-size: 18px;
        color: #ff9800;
      }

      #loadMoreBtn {
        display:block; 
        margin:10px auto 50px; 
      }

      .festival-name {
        margin: 5px 20px 10px;
      }

    </style>
</head>
<body>
    <div id="wrap">
      {% include "header.html" %}
        <div id="banner_blur">
          <h1>Explore festivals</h1>
          <form id='searchForm' action="#" method="GET">
            <div id="searchBlocks">
              <div class="searchBlock name">
                <h3>Festival Name</h3>
                <input type="text" name='name' id="name" placeholder="Name Search">
              </div>
              <div class="searchBlock region">
                <h3>Region</h3>
                <input type="text" name="region" id="region" placeholder="Ex: Seoul, Busan">
              </div>

              <div class="searchBlock date">
                <h3>Date</h3>
                <div class="stardToEnd">
                  <div>
                    <label for="startDate">Start Date</label>
                    <input type="date" name="startDate" id="startDate">
                  </div>
                  <span>~</span>
                  <div>
                    <label for="endDate">End Date</label>
                    <input type="date" name="endDate" id="endDate">
                  </div>
                </div>
              </div>

              <div class="searchBlock button">
                <button type="submit">Search</button>
              </div>
            </div>
          </form>
        </div>
            
        <div class="contents">  
            <div id="festList">
                
            </div>
            <button id="loadMoreBtn" class="white-orange-active moreBtn">view more</button>
        </div>
    </div>
    <script>
        let allFestivalData = []; // AJAX ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì €ì¥í•  ë°°ì—´
        let loadedCount = 0;      // í˜„ì¬ê¹Œì§€ ë¡œë“œëœ ì¹´ë“œ ìˆ˜
        const LOAD_COUNT = 9;     // ì´ˆê¸° ë¡œë“œ ê°œìˆ˜ (ê²€ìƒ‰ ì‹œ)
        const LOAD_MORE_COUNT = 9; // 'ë”ë³´ê¸°' í´ë¦­ ì‹œ ì¶”ê°€ ë¡œë“œ ê°œìˆ˜

        // DOM ìš”ì†Œ ìºì‹± (ìì£¼ ì‚¬ìš©í•˜ë¯€ë¡œ ë³€ìˆ˜ì— ì €ì¥)
        const festList = document.getElementById('festList');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const searchForm = $('#searchForm'); // jQuery ê°ì²´ë¡œ ìºì‹±

        function appendCards(dataArray, count) {
            // 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' ë©”ì‹œì§€ê°€ ìˆë‹¤ë©´ ì œê±°
            $('#no-results-message').remove();

            let appendedThisCall = 0; // ì´ë²ˆ í˜¸ì¶œì—ì„œ ì‹¤ì œë¡œ ì¶”ê°€ëœ ì¹´ë“œ ìˆ˜

            for (let i = 0; i < count; i++) {
                if (loadedCount >= dataArray.length) {
                    break; // ë” ì´ìƒ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë°˜ë³µ ì¤‘ë‹¨
                }
                const data = dataArray[loadedCount];
                const card = document.createElement('div');
                card.className = 'festCard';
                card.innerHTML = `
                    <a href="/festivals/view/${data.id}">
                        <img src="${data.image}" width='100%' height='60%' alt="${data.name}">
                    </a>
                    <p>
                      <div class="festival-header">
                        <div class="festival-name">${data.name}</div>
                        <div class="rating-region">
                          <span class="festival-rating">â­ ${data.rating || '0.0'}</span>
                          <span class="region-info">ğŸŒ ${data.region}</span>
                        </div>
                        <p class="date-info">ğŸ“… ${data.start_date || 'ë‚ ì§œ ë¯¸ì •'} ~ ${data.end_date || 'ë‚ ì§œ ë¯¸ì •'}</p>
                      </div>
                    </p>

                    <div class="festival-tags">
                        ${(data.tags || []).map(tag => `<span class="tag">#${tag}</span>`).join(' ')}
                      </div>

                    
                `;
                festList.appendChild(card);
                loadedCount++;
                appendedThisCall++;
            }

            // 'ë”ë³´ê¸°' ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ ì—…ë°ì´íŠ¸
            if (loadMoreBtn) { // ë²„íŠ¼ ìš”ì†Œê°€ ì¡´ì¬í•  ë•Œë§Œ ì²˜ë¦¬
                if (loadedCount < dataArray.length) {
                    loadMoreBtn.style.display = 'block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            }

            // ë°ì´í„°ê°€ ì•„ì˜ˆ ì—†ê±°ë‚˜, ì´ë²ˆ í˜¸ì¶œì—ì„œ ì•„ë¬´ê²ƒë„ ì¶”ê°€ë˜ì§€ ì•Šì•˜ê³ , ì´ë¯¸ ëª¨ë“  ë°ì´í„°ë¥¼ ë‹¤ ë¡œë“œí–ˆìŒì—ë„ ë¶ˆêµ¬í•˜ê³  ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
            if (loadedCount === 0 && dataArray.length === 0) {
                // ë©”ì‹œì§€ê°€ ì•„ì§ ì—†ë‹¤ë©´ ì¶”ê°€
                if (!$('#no-results-message').length) {
                    festList.innerHTML = '<p id="no-results-message">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            }
        }

        // ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë”©ì„ ë‹´ë‹¹í•˜ëŠ” í•¨ìˆ˜
        function loadAndDisplayFestivals(isSearch = false) {
            // ê²€ìƒ‰ ìš”ì²­ì´ê±°ë‚˜ ì²« ë¡œë“œê°€ ì•„ë‹ ë•Œë§Œ ê¸°ì¡´ ê²°ê³¼ ì´ˆê¸°í™”
            if (isSearch) {
                festList.innerHTML = ''; // ì´ì „ ê²°ê³¼ ëª¨ë‘ ì§€ìš°ê¸°
                loadedCount = 0;         // ë¡œë“œ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
                if (loadMoreBtn) loadMoreBtn.style.display = 'none'; // ë²„íŠ¼ ìˆ¨ê¹€
                allFestivalData = []; // ìƒˆë¡œìš´ ê²€ìƒ‰ì„ ìœ„í•´ ë°ì´í„° ë°°ì—´ ì´ˆê¸°í™”
            }

            // í¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì´ˆê¸° ë¡œë“œ ì‹œì—ëŠ” ëª¨ë‘ ë¹ˆ ë¬¸ìì—´ì´ ë  ê²ƒì„)
            const name = $('#name').val();
            const region = $('#region').val();
            const startDate = $('#startDate').val();
            const endDate = $('#endDate').val();

            const queryParams = {
                name:name,
                region: region,
                startDate: startDate,
                endDate: endDate
            };

            $.ajax({
                url: '/festivals/search/',
                type: 'GET',
                data: queryParams,
                dataType: 'json',
                success: function(data) {
                    allFestivalData = data; // AJAX ê²€ìƒ‰ ê²°ê³¼ë¥¼ allFestivalDataì— ì €ì¥
                    appendCards(allFestivalData, LOAD_COUNT); // ì²« ì¹´ë“œ ë¬¶ìŒ ì¶œë ¥

                    const newUrl = new URL(window.location.origin + window.location.pathname);
                    // ëª¨ë“  ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ URLì— ì¶”ê°€
                    for (const key in queryParams) {
                        if (queryParams[key]) { // ê°’ì´ ìˆì„ ë•Œë§Œ ì¶”ê°€
                            newUrl.searchParams.set(key, queryParams[key]);
                        } else {
                            newUrl.searchParams.delete(key); // ê°’ì´ ì—†ìœ¼ë©´ URLì—ì„œ ì œê±°
                        }
                    }

                    if (isSearch) { // ìƒˆë¡œìš´ ê²€ìƒ‰ì¼ ë•Œë§Œ íˆìŠ¤í† ë¦¬ ìŠ¤íƒì— ì¶”ê°€
                        window.history.pushState(null, '', newUrl.toString());
                    } else { // 'ë”ë³´ê¸°'ë‚˜ ì´ˆê¸° ë¡œë“œ ë“± ê²€ìƒ‰ ìƒíƒœë¥¼ ë°”ê¾¸ì§€ ì•ŠëŠ” ê²½ìš° (ì„ íƒ ì‚¬í•­)
                            // replaceStateë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ URLì„ ëŒ€ì²´ (íˆìŠ¤í† ë¦¬ ìŠ¤íƒì— ì¶”ê°€ ì•ˆ í•¨)
                        window.history.replaceState(null, '', newUrl.toString());
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("AJAX Error: " + textStatus, errorThrown, jqXHR.responseText);
                    festList.innerHTML = '<p id="no-results-message">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
                    if (loadMoreBtn) loadMoreBtn.style.display = 'none';
                }
            });
        }

        $(document).ready(function() {
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', () => {
                    appendCards(allFestivalData, LOAD_MORE_COUNT);
                });
            }

            searchForm.on('submit', function(event) {
                event.preventDefault(); // í¼ ê¸°ë³¸ ì œì¶œ ë™ì‘ ë°©ì§€
                loadAndDisplayFestivals(true); // ê²€ìƒ‰ì„ì„ ì•Œë¦¬ê³  ë°ì´í„° ë¡œë“œ
            });

            const currentUrl = new URL(window.location.href);
            const urlSearchParams = currentUrl.searchParams;

            // URLì— ê²€ìƒ‰ íŒŒë¼ë¯¸í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
            const hasSearchParams = Array.from(urlSearchParams.values()).some(param => param.length > 0);

            if (hasSearchParams) {
                // URL íŒŒë¼ë¯¸í„°ê°€ ìˆë‹¤ë©´, í¼ í•„ë“œì— ê°’ì„ ì±„ì›Œë„£ê³  ë°”ë¡œ ê²€ìƒ‰ ì‹¤í–‰
                $('#name').val(urlSearchParams.get('name') || '');
                $('#region').val(urlSearchParams.get('region') || '');
                $('#startDate').val(urlSearchParams.get('startDate') || '');
                $('#endDate').val(urlSearchParams.get('endDate') || '');
                
                loadAndDisplayFestivals(false); // ì´ˆê¸° ë¡œë“œì„ì„ ì•Œë¦¬ë©° ê²€ìƒ‰ ì‹¤í–‰
            } else {
                // URL íŒŒë¼ë¯¸í„°ê°€ ì—†ë‹¤ë©´, ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ë¹ˆ ê²€ìƒ‰ìœ¼ë¡œ)
                loadAndDisplayFestivals(false);
            } 
        });
    </script>
    {% include "footer.html" %}
    
</body>
</html>