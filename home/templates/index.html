{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" type="text/css" href="/static/css/header.css">
  <link rel="stylesheet" type="text/css" href="/static/css/navigation.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css">
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <title>HOME</title>
  <style>
    * {margin: 0; padding: 0; box-sizing: border-box;}
    ul, li {list-style: none;}
    a {text-decoration: none;}

    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    #wrap {
      flex: 1;
    }

    #searchAll{
      display: flex;
    }

    #searchAll .searchIco{
      width: 48px;
      height: 60px;
      display: flex;
      align-items: center;
      margin-right: 10px
    }

    .searchKey {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .searchKey input {
      padding: 12px 18px;
      font-size: 1.2rem;
      border: 2px solid #ffb300;
      border-radius: 6px;
      height: 60px;
      width: 400px;
    }

    .searchKey input:focus {
      outline: none;
      border: 2px solid #4fc3f7;
    }

    .searchKey button {
      padding: 12px 24px;
      font-size: 1.1rem;
      height: 60px;
      border-radius: 6px;
      background: linear-gradient(90deg, #ffb300 0%, #4fc3f7 100%); 
      color: white;
      border: none;
      cursor: pointer;
    }

    .contents::selection{
      background-color: red;
    }

    .contents {
      width: 100%;
      min-height: 1000px;
      height:1600px;
      padding: 30px 0;
    }

    #shortsContainer {
      width: 32%;
      height: 800px;
      margin: 20px auto;
      display: flex;
      justify-content: space-evenly;
      
    }
    
    .creator {
      position: absolute;
      top: 630px;
      left: -px;
      z-index: 2;
      background: #fff;
      color: #222;
      font-weight: bold;
      padding: 6px 18px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      font-size: 1.08rem;
      border: 1px solid #ddd;
    }

    #shortsBorder {
      width: 75%;
      height: 800px;
      margin: 0 0 0 40px;
      background: #39555e;
      border: 1px solid #ddd;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #shorts {
      width: 90%;
      height: 85%;
      background: #fff;
      display: flex; 
      position: relative;
    }

    #shortsMeta {
      width: 90%;
      
      padding-top: 18px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 18px;
      font-size: 1.08rem;
      color: #222;
    }

    #shortsMeta a {
      font-weight: bold;
      color: #fff;
      text-decoration: none;
    }

    #shortsMeta span a {
      color: #000000;
      text-decoration: none;
      margin-left: 10px;
      display: inline-block;
      border-radius: 10px;
      padding: 5px 10px;
      background: #ffffff;
      box-shadow:  0 2px 2px rgba(0, 0, 0, 1);
    }


    #shortsIcoContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      padding: 20px 0;
      gap: 20px;
      height: 95%;
      
    }

    .iconBtn {
      font-size: 23px;
      cursor: pointer;
      background: none;
      border: none;
    }

    #shortsIcoContainer {
      display: flex;
      flex-direction: column;
      
      justify-content: flex-end;
    }

    .createBtn {
      /* 아래쪽 여백을 자동으로 늘려서 맨 위로 보냄 */
      margin-bottom: auto;
      background: linear-gradient(90deg, #ffb300 0%, #4fc3f7 100%); 
      color: white;
      border-radius: 10%;
      width: 100%;
    }

    .list::selection{
      background-color: red;
    }

    .list {
      width: 100%;
      min-height: 1000px;

      padding: 30px 0;
    }

    .listTitle {
      width: 60%;
      height: 100px;
      margin: 0 auto;
      text-align: center;
      border-top: rgba(0,0,0,0.1) 1px solid;
      align-items: center;
      display: flex;
      justify-content: center;
    }

    .listTitle h3 {
      margin: auto;
      font-size: 2rem;
      font-weight: bold;
      text-align: center;
    }
    .recommendFestList {
      width: 60%;
      margin: 10px auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 40px;
      
      padding: 20px 0 60px 0;
    }

    .festCard {
      width: 200px;
      height: 250px;
      
      border-radius: 10px;
      overflow: hidden;
      text-align: center;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
      background-color: white;
    }

    .festCard img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }

    .festCard p {
      margin-top: 10px;
      font-weight: bold;
      font-size: 1rem;
    }

    #footer {
      padding: 20px;
      background-color: #f1f1f1;
      font-size: 0.9rem;
      color: #666;
      text-align: center;
      
    }

    .footer-links {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      list-style: none;
      margin-top: 10px;
    }

    .footer-links a {
      text-decoration: none;
      color: #666;
    }

    .footer-links a:hover {
      text-decoration: underline;
    }

     /* .dark 모드가 걸리면 전체 배경·글자색 변경 */
    body.dark {
      background-color: #121212;
      color: #e0e0e0;
    }

    body.dark .contents {
    background-color: #121212; /* 또는 #1a1a1a 등 어두운 회색 */
    }



    /* 네비게이션, 푸터 등도 함께 스타일링 */
    body.dark #nav,
    body.dark #footer,
    body.dark #pageMove,
    body.dark #shortsBorder {
      background-color: #1f1f1f;
      color: #e0e0e0;
      border-color: #333;
    }

    /* 버튼 호버 효과를 더 눈에 띄게 */
    body.dark .searchKey button:hover,
    body.dark .iconBtn:hover,
    body.dark .ldBtn:hover {
      filter: brightness(1.2);
    }


    /* 검색창, 카드 등 박스 배경 */
    body.dark .searchKey input,
    body.dark .festCard {
      background-color: #1e1e1e;
      border: #333;
      color: #f0f0f0;
    }

   
   
    /* 카드 내부 텍스트 */
    body.dark .festCard p {
      color: #ffffff;
    }

    /* tags */
    body.dark #shortsMeta span a {
      background-color: #2a2a2a;
      color: #ffffff;
      border: 1px solid #444;
    }

    /* 링크 hover */
    body.dark a:hover {
      color: #6ef8f1;
      text-decoration: underline;
    }

    /* 다크모드에서 선택 영역 색상 변경 */
    body.dark ::selection {
      background-color: #4fc3f7;
      color: #000;
    }

  </style>
  <script>
let scrollTimer;
let currentShortIndex = 0; // 현재 표시 중인 쇼츠의 인덱스 (shortformsData 배열 기준)
let currentImageIndex = 0; // 현재 쇼츠 내에서 이미지 순환을 위한 인덱스
let startX, isDragging = false; // 드래그 관련 변수
let shortformsData = []; // sList에서 받아온 모든 쇼츠 데이터를 저장할 변수
let festivalsData = []; // jList에서 받아온 모든 축제 데이터를 저장할 변수

// DOM이 로드되면 바로 실행
document.addEventListener('DOMContentLoaded', function() {
    AOS.init({
        duration: 1000, // 기본 애니메이션 지속 시간
        once: true, // 애니메이션을 한 번만 실행
    }); 

    setupInitialShortsUI('bottom'); 

    // 모든 AJAX 요청이 완료된 후에 실행될 Promise.all 사용
    Promise.all([
        // sList AJAX 요청 (쇼츠 데이터)
        $.ajax({
            url: '/slist/', 
            type: 'GET',
            dataType: 'json'
        }),
        // jList AJAX 요청 (축제 리스트 데이터)
        $.ajax({
            url: '/jlist/',
            type: 'GET',
            dataType: 'json'
        })
    ])
    .then(function(results) {
        // 모든 AJAX 요청이 성공적으로 완료되었을 때 실행
        const shortformsResponse = results[0]; // sList 응답
        const festivalsResponse = results[1]; // jList 응답

        // shortformsData 할당 (data.shortforms로 접근)
        shortformsData = shortformsResponse.shortforms || []; 

        // festivalsData 할당 (jList 응답 그대로 할당)
        festivalsData = festivalsResponse || []; 

        // 데이터 유효성 검사
        if (!Array.isArray(festivalsData) || festivalsData.length === 0) {
            console.error("Error: No festival data received from jlist or data is not an array.");
            $('.listTitle').html('<p>축제 데이터를 불러올 수 없습니다.</p>');
        } else {
            addlist(festivalsData); // 축제 리스트 UI 업데이트
        }

        if (!Array.isArray(shortformsData) || shortformsData.length === 0) {
            console.error("Error: No shortform data received from slist or data is not an array.");
            $('#shorts').html('<p>쇼츠 데이터를 불러올 수 없습니다.</p>');
        } else {
            // 초기 쇼츠 UI 업데이트 (첫 번째 쇼츠 데이터로)
            updateShortsContent(shortformsData[currentShortIndex]); 
            // 5초마다 이미지 순환 시작 (현재 쇼츠 내 이미지)
            setInterval(changeShortsImage, 5000); 
        }
    })
    .catch(function(error) {
        // Promise.all 중 하나라도 실패하면 실행
        console.error('데이터 로드 중 오류 발생:', error);
        $('#shortsContainer').html('<p>데이터를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.</p>');
        $('.listTitle').html('<p>축제 정보를 불러오는 중 오류가 발생했습니다.</p>');
    });

    // #shortsContainer에 대한 휠 이벤트 리스너 (jQuery ready 함수 안으로 이동)
    $('#wrap').on('wheel', '#shortsContainer', function(e) {
        e.preventDefault();
        clearTimeout(scrollTimer);

        if (!shortformsData || shortformsData.length === 0) { 
            return; // 쇼츠 데이터가 없으면 스크롤 동작 안 함
        }

        if (e.originalEvent.deltaY > 0) { // 휠을 내리면 (다음 쇼츠)
            if (currentShortIndex < shortformsData.length - 1) { 
                scrollTimer = setTimeout(function() {
                    currentShortIndex++;
                    currentImageIndex = 0; // 새 쇼츠로 이동하면 이미지 인덱스 초기화
                    applyAOSAnimation('up'); // 쇼츠 컨테이너 AOS 애니메이션
                    updateShortsContent(shortformsData[currentShortIndex]); // 데이터 기반으로 쇼츠 콘텐츠 업데이트
                }, 500); // 0.5초 디바운스
            }
        } else { // 휠을 올리면 (이전 쇼츠)
            if (currentShortIndex > 0) { 
                scrollTimer = setTimeout(function() {
                    currentShortIndex--;
                    currentImageIndex = 0; // 새 쇼츠로 이동하면 이미지 인덱스 초기화
                    applyAOSAnimation('down'); // 쇼츠 컨테이너 AOS 애니메이션
                    updateShortsContent(shortformsData[currentShortIndex]); // 데이터 기반으로 쇼츠 콘텐츠 업데이트
                }, 500); // 0.5초 디바운스
            }
        }
    });
}); // document.ready end

// setupInitialShortsUI 함수 (DOMContentLoaded 안에 있었으므로, 필요에 따라 외부로 뺄 수 있습니다)
function setupInitialShortsUI(animove) {
    const initialShortsHtml = `
        <div id="shortsContainer" data-aos="fade-${animove}"> 
            <div id="shortsBorder"> 
                <data id="shorts">
                    <img src="" width='100%' height='100%' alt="쇼츠 이미지">
                    <a class="creator">@축제모아</a>
                    <a class="shorts_title">요즘 입소문 탄다는 축제</a>
                </data>
                <div id="shortsMeta">
                    <a href="#" class="festNameInShorts"></a>
                    <span class="tags" style="font-size: 15px;"></span>
                </div>
            </div>
            <div id="shortsIcoContainer">
                <button class="iconBtn createBtn" onclick="createBtn()">+</button>
                <button class="iconBtn likeBtn" onclick="likeBtn()">❤️</button>
                <button class="iconBtn shareBtn" onclick="shareBtn()">🔄</button>
                <button class="iconBtn reviewBtn" onclick="reviewBtn()">📝</button>
                <button class="iconBtn viewBtn" onclick="viewBtn()">👁️</button>
            </div>
        </div>
        <div class="listTitle"><h3> Festivals</h3></div>
        <div class="recommendFestList"></div>`; // 닫는 <div> 태그는 addlist에서 추가될 것이므로 여기서 제거
    $('.contents').html(initialShortsHtml);
    AOS.refresh(); 
}

// shortsContainer의 AOS 애니메이션만 적용하는 함수
function applyAOSAnimation(animove) {
    $('#shortsContainer').attr('data-aos', `fade-${animove}`);
    AOS.refresh(); 
}

// shortsContainer 내부의 콘텐츠를 데이터에 맞춰 업데이트하는 함수
function updateShortsContent(shortformItem) {
    if (!shortformItem) {
        console.warn("shortformItem이 유효하지 않습니다.");
        return;
    }
    
    // 쇼츠 제목 업데이트
    $('#shorts .shorts_title').text(shortformItem.title); // 'shorts_title' 클래스 사용

    // 1. 쇼츠 이미지 업데이트
    const imageUrl = shortformItem.images && shortformItem.images.length > currentImageIndex ?
                     shortformItem.images[currentImageIndex].image_url : ''; 
    $('#shorts img').attr('src', imageUrl); 

    // 2. 축제 이름 업데이트
    const festival = shortformItem.festival;
    const festivalName = festival && festival.name ? festival.name : '없어진 축제입니다';
    const festivalId = festival && festival.id ? festival.id : null;

    $('.festNameInShorts').text(festivalName);
    if (festivalId) {
        $('.festNameInShorts').attr('href', `/festivals/view/${festivalId}/`);
    } else {
        $('.festNameInShorts').removeAttr('href').css('cursor', 'default'); 
    }

    // 3. 축제 태그 업데이트
    const tagsHtml = (festival && festival.tags && Array.isArray(festival.tags) && festival.tags.length > 0) ?
        festival.tags.map(tag => `<a href="result_list.html?tag=${encodeURIComponent(tag.name)}">#${tag.name}</a>`).join(' ') : '';
    $('.tags').html(tagsHtml);
}

// 현재 쇼츠 내에서 이미지를 순환하는 함수
function changeShortsImage() {
    if (!shortformsData || shortformsData.length === 0) return; // 데이터 없으면 종료

    const currentShort = shortformsData[currentShortIndex]; // 현재 표시 중인 쇼츠 데이터
    if (currentShort && currentShort.images && currentShort.images.length > 0) {
        currentImageIndex++;
        if (currentImageIndex >= currentShort.images.length) { 
            currentImageIndex = 0; // 현재 쇼츠의 모든 이미지를 봤으면 다시 첫 번째 이미지로
        }
        // 현재 쇼츠 (currentShortIndex)의 currentImageIndex번째 이미지로 업데이트
        updateShortsContent(currentShort); 
    }
}

// addlist 함수 (추천 축제 리스트를 동적으로 생성)
function addlist(data){ // data 인자로 festivalsData를 받습니다
    let jdata = ``;
    for (let k = 0; k < data.length && k < 8; k++) { // 최대 8개 또는 data.length 만큼
        const festival = data[k];
        // image 필드는 jlist 응답의 festival 객체에 직접 있어야 합니다.
        // 예를 들어, festival.image_url 또는 festival.main_image_url
        // 현재 코드에서는 `festival.image`를 사용하고 있으므로, `jlist`에서 해당 필드를 제공한다고 가정합니다.
        const imageUrl = festival.image || '경로/기본_이미지.png'; // 이미지가 없으면 기본 이미지
        jdata += `<a href="/festivals/view/${festival.id}/"><div class="festCard"><img src="${imageUrl}" alt="${festival.name} 축제 이미지"><p>${festival.name}</p></div></a>`;
    }
    $('.recommendFestList').html(jdata); // div 닫는 태그는 HTML 구조에 따라 처리
}

// 아이콘 버튼 핸들러 함수들
function createBtn() { console.log('Create Button clicked'); }
function likeBtn() { console.log('Like Button clicked'); }
function shareBtn() { console.log('Share Button clicked'); }
function reviewBtn() { console.log('Review Button clicked'); }
function viewBtn() { console.log('View Button clicked'); }
</script>
</head>

<body>
  <div id="wrap">
    <div id="nav">
      <div id="logo">
        <button type="button" class="logoBtn" onclick="logoBtn()"><img id="logo_img" src="/static/image/logo_transparent_cut.png" alt="Logo" ></button>
      </div>

      <div id="searchAll">
        <div class="searchIco">🔍</div>
        <form action="fest_list.html" method="GET">
          <div class="searchKey">
            <input name="keyWord" type="text" placeholder="축제명, 지역, 태그 등으로 검색" />
            <button type="submit">검색</button>
          </div>
        </form>
      </div>

      <div id="pageMove">     
        <ul>
          <li><a href="/festivals/list/">festivals</a></li>
          {% if user_id %}
              <li><span style="color:#2563eb;">{{ nickname }}님</span></li>
              <li><a href="/accounts/logout/">logout</a></li>
              <li><a href="/accounts/mypage/">my page</a></li>
          {% else %}
              <li><a href="/accounts/login/">login</a></li>
              <li><a href="/accounts/signup/terms/">sign up</a></li>
          {% endif %}
          <li><a href="/inquiry/support/">support</a></li>  
        </ul>
      </div>

    </div>

    <div class="contents">
      
  </div>
 
  <div id="footer">
    <h4>© 2025 FastFest | 사이트 개발자 정보</h4>
    <ul class="footer-links">
      <li><a href="#">개인정보처리방침</a></li>
      <li><a href="#">이용약관</a></li>
      <li><a href="#">관리자페이지 이동</a></li>
      <li>
        <div id="ldMode">
          <button type="button" class="ldBtn" onclick="ldBtn()">다크모드</button>
        </div>
      </li>
    </ul>
  </div>
</body>
  <script>
    function logoBtn() {
      alert('go home');
    }

    function viewBtn() {
      alert('로그인 후 이용 가능');
    }

    function reviewBtn() {
      alert('로그인 후 이용 가능');
    }

    function shareBtn() {
      alert('로그인 후 이용 가능');
    }

    function likeBtn() {
      alert('로그인 후 이용 가능');
    }

    function createBtn() {
      location.href='/shortforms/upload/';
    }

    //JS: body.dark 클래스를 토글
    function ldBtn() {
    document.body.classList.toggle('dark');
    // (선택) 로컬 스토리지에 상태 저장
    const isDark = document.body.classList.contains('dark');
    localStorage.setItem('darkMode', isDark);
    }
  </script>