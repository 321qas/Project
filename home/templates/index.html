{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" type="text/css" href="/static/css/navigation.css">
  <link rel="stylesheet" type="text/css" href="/static/css/footer.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css"> 
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <title>HOME</title>
  <style>
    a {text-decoration: none;}

    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: #f8fafc;
    }

    #wrap {
      flex: 1;
    }

    #searchAll{
      position: absolute;
      right: 700px;
    }

    #searchAll .searchIco{
      width: 48px;
      height: 60px;
      display: flex;
      align-items: center;
      margin-right: 10px
    }

    .searchKey {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .searchKey input {
      padding: 12px 18px;
      font-size: 1.2rem;
      border: 2px solid #ffb300;
      border-radius: 6px;
      height: 60px;
      width: 400px;
    }

    .searchKey input:focus {
      outline: none;
      border: 2px solid #4fc3f7;
    }

    .searchKey button {
      padding: 12px 24px;
      font-size: 1.1rem;
      height: 60px;
      border-radius: 6px;
      background: linear-gradient(90deg, #ffb300 0%, #4fc3f7 100%); 
      color: white;
      border: none;
      cursor: pointer;
    }

    .contents::selection{
      background-color: red;
    }

    .contents {
      width: 100%;
      min-height: 1000px;
      height:1600px;
    }

    #shortsContainer {
      width: 32%;
      height: 800px;
      margin: 20px auto;
      display: flex;
      justify-content: space-evenly;
      
    }
    
    .creator {
      position: absolute;
      top: 630px;
      left: -px;
      z-index: 2;
      background: #fff;
      color: #222;
      font-weight: bold;
      padding: 6px 18px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      font-size: 1.08rem;
      border: 1px solid #ddd;
    }

    #shortsBorder {
      width: 75%;
      height: 800px;
      margin: 0 0 0 40px;
      background: #39555e;
      border: 1px solid #ddd;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #shorts {
      width: 90%;
      height: 85%;
      background: #fff;
      display: flex; 
      position: relative;
    }

    #shortsMeta {
      width: 90%;
      
      padding-top: 18px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 18px;
      font-size: 1.08rem;
      color: #222;
    }

    #shortsMeta a {
      font-weight: bold;
      color: #fff;
      text-decoration: none;
    }

    #shortsMeta span a {
      color: #000000;
      text-decoration: none;
      margin-left: 10px;
      display: inline-block;
      border-radius: 10px;
      padding: 5px 10px;
      background: #ffffff;
      box-shadow:  0 2px 2px rgba(0, 0, 0, 1);
    }


    #shortsIcoContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      padding: 20px 0;
      gap: 20px;
      height: 95%;
      
    }

    .iconBtn {
      font-size: 23px;
      cursor: pointer;
      background: none;
      border: none;
    }

    #shortsIcoContainer {
      display: flex;
      flex-direction: column;
      
      justify-content: flex-end;
    }

    .createBtn {
      /* 아래쪽 여백을 자동으로 늘려서 맨 위로 보냄 */
      margin-bottom: auto;
      background: linear-gradient(90deg, #ffb300 0%, #4fc3f7 100%); 
      color: white;
      border-radius: 10%;
      width: 100%;
    }

    .list::selection{
      background-color: red;
    }

    .list {
      width: 100%;
      min-height: 1000px;

      padding: 30px 0;
    }

    .listTitle {
      width: 60%;
      height: 100px;
      margin: 0 auto;
      text-align: center;
      border-top: rgba(0,0,0,0.1) 1px solid;
      align-items: center;
      display: flex;
      justify-content: center;
    }

    .listTitle h3 {
      margin: auto;
      font-size: 2rem;
      font-weight: bold;
      text-align: center;
    }
    .recommendFestList {
      width: 60%;
      margin: 10px auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 40px;
      
      padding: 20px 0 60px 0;
    }

    .festCard {
      width: 200px;
      height: 250px;
      
      border-radius: 10px;
      overflow: hidden;
      text-align: center;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
      background-color: white;
    }

    .festCard img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }

    .festCard p {
      margin-top: 10px;
      font-weight: bold;
      font-size: 1rem;
    }

     /* .dark 모드가 걸리면 전체 배경·글자색 변경 */
    body.dark {
      background-color: #121212;
      color: #e0e0e0;
    }

    body.dark .contents {
    background-color: #121212; /* 또는 #1a1a1a 등 어두운 회색 */
    }



    /* 네비게이션, 푸터 등도 함께 스타일링 */
    body.dark #nav,
    body.dark #footer,
    body.dark #pageMove,
    body.dark #shortsBorder {
      background-color: #1f1f1f;
      color: #e0e0e0;
      border-color: #333;
    }

    /* 버튼 호버 효과를 더 눈에 띄게 */
    body.dark .searchKey button:hover,
    body.dark .iconBtn:hover,
    body.dark .ldBtn:hover {
      filter: brightness(1.2);
    }


    /* 검색창, 카드 등 박스 배경 */
    body.dark .searchKey input,
    body.dark .festCard {
      background-color: #1e1e1e;
      border: #333;
      color: #f0f0f0;
    }

   
   
    /* 카드 내부 텍스트 */
    body.dark .festCard p {
      color: #ffffff;
    }

    /* tags */
    body.dark #shortsMeta span a {
      background-color: #2a2a2a;
      color: #ffffff;
      border: 1px solid #444;
    }

    /* 링크 hover */
    body.dark a:hover {
      color: #6ef8f1;
      text-decoration: underline;
    }

    /* 다크모드에서 선택 영역 색상 변경 */
    body.dark ::selection {
      background-color: #4fc3f7;
      color: #000;
    }

  </style>
  <script>
    let scrollTimer;
    let i = 0; // 현재 표시 중인 쇼츠의 인덱스 (alldata 배열 기준)
    let j = 0; // 현재 쇼츠 내에서 이미지 순환을 위한 인덱스
    let startX, isDragging = false;
    let alldata = []; // AJAX로 받아온 모든 축제 데이터를 저장할 전역 변수

    // DOM이 로드되면 바로 실행
    document.addEventListener('DOMContentLoaded', function() {
        AOS.init({
            duration: 1000, // 기본 애니메이션 지속 시간
            once: true, // 애니메이션을 한 번만 실행
        }); 

        setupInitialShortsUI('bottom'); 

        $.ajax({
            url: '/jlist/',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                // ★ 2. AJAX 데이터 성공 시 전역 변수 alldata에 저장
                alldata = data; 

                // 데이터 유효성 검사
                if (!Array.isArray(alldata) || alldata.length === 0) {
                    console.error("Error: No festival data received or data is not an array.");
                    $('.listTitle').html('<p>축제 데이터를 불러올 수 없습니다.</p>');
                    return;
                }

                addlist(alldata); 
                updateShortsContent(alldata[i]); 
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("AJAX Error: " + textStatus, errorThrown, jqXHR.responseText);
                $('.listTitle').html('<p>축제 정보를 불러오는 중 오류가 발생했습니다.</p>');
            }
        });
    });

    $(document).ready(function() {
        $('#wrap').on('wheel', '#shortsContainer', function(e) {
            e.preventDefault();
            clearTimeout(scrollTimer);

            if (!alldata || alldata.length === 0) { // 데이터가 없으면 스크롤 동작 안 함
                return;
            }

            if (e.originalEvent.deltaY > 0) {  // 휠을 내리면 (다음 쇼츠)
                // 현재 인덱스가 전체 데이터의 마지막이 아니라면 이동
                if (i < alldata.length - 1) { 
                    scrollTimer = setTimeout(function() {
                        i++;
                        j = 0; // 새 쇼츠로 이동하면 이미지 인덱스 초기화
                        applyAOSAnimation('up'); // 쇼츠 컨테이너 AOS 애니메이션
                        updateShortsContent(alldata[i]); // 데이터 기반으로 쇼츠 콘텐츠 업데이트
                    }, 500);
                }
            } else {  // 휠을 올리면 (이전 쇼츠)
                if (i > 0) { // 첫 번째 축제가 아니라면
                    scrollTimer = setTimeout(function() {
                        i--;
                        j = 0; // 새 쇼츠로 이동하면 이미지 인덱스 초기화
                        applyAOSAnimation('down'); // 쇼츠 컨테이너 AOS 애니메이션
                        updateShortsContent(alldata[i]); // 데이터 기반으로 쇼츠 콘텐츠 업데이트
                    }, 500);
                }
            }
        });
    });

    function setupInitialShortsUI(animove) {
        const initialShortsHtml = `
            <div id="shortsContainer" data-aos="fade-${animove}"> 
                <div id="shortsBorder"> 
                    <data id="shorts"><img src="" width='100%' height='100%' alt="쇼츠 이미지"></data>
                    <div id="shortsMeta">
                        <a href="#" class="festNameInShorts"></a>
                        <span class="tags" style="font-size: 15px;"></span>
                    </div>
                </div>
                <div id="shortsIcoContainer">
                    <button class="iconBtn createBtn" onclick="createBtn()">+</button>
                    <button class="iconBtn likeBtn" onclick="likeBtn()">❤️</button>
                    <button class="iconBtn shareBtn" onclick="shareBtn()">🔄</button>
                    <button class="iconBtn reviewBtn" onclick="reviewBtn()">📝</button>
                    <button class="iconBtn viewBtn" onclick="viewBtn()">👁️</button>
                </div>
            </div>
            <div class="listTitle"><h3> Festivals</h3></div>
            <div class="recommendFestList">`;
        $('.contents').html(initialShortsHtml);
        AOS.refresh(); // AOS가 새로 생성된 요소들을 인식하도록 새로고침
    }

    // shortsContainer의 AOS 애니메이션만 적용하는 함수
    function applyAOSAnimation(animove) {
        $('#shortsContainer').attr('data-aos', `fade-${animove}`);
        AOS.refresh(); // AOS 애니메이션 새로고침
    }

    // shortsContainer 내부의 콘텐츠를 데이터에 맞춰 업데이트하는 함수
    function updateShortsContent(festivalItem) {
        if (!festivalItem) return;

        // 이미지 업데이트 (festivalItem.sorted_images가 배열이고, j 인덱스가 유효한지 확인)
        const imageUrl = festivalItem.sorted_images && festivalItem.sorted_images.length > j ? 
                         festivalItem.sorted_images[j].image.url : '';
        $('#shorts img').attr('src', imageUrl);
        
        // 축제 이름 업데이트
        $('.festNameInShorts').text(festivalItem.name);
        $('.festNameInShorts').attr('href', `/festivals/view/${festivalItem.id}/`); 

        const tagsHtml = (festivalItem.tags && Array.isArray(festivalItem.tags) && festivalItem.tags.length > 0) ?
            festivalItem.tags.map(tag => `<a href="result_list.html?tag=${tag}">#${tag}</a>`).join(' ') : '';
        $('.tags').html(tagsHtml); 
    }

    // 자동 콘텐츠 변경 (5초마다) - 현재 쇼츠 내에서 이미지 순환
    function changeContent() {
        if (!alldata || alldata.length === 0) return; // 데이터 없으면 종료

        const currentFestival = alldata[i]; // 현재 표시 중인 쇼츠 데이터
        if (currentFestival && currentFestival.sorted_images) {
            j++;
            if (j >= currentFestival.sorted_images.length) { 
                j = 0; // 현재 쇼츠의 모든 이미지를 봤으면 다시 첫 번째 이미지로
            }
            // 현재 쇼츠 (i)의 j번째 이미지로 업데이트
            updateShortsContent(currentFestival); 
        }
    }

    // 5초마다 콘텐츠 변경 타이머 시작
    setInterval(changeContent, 5000);

    // addlist 함수 (추천 축제 리스트를 동적으로 생성)
    function addlist(data){ // data 인자로 alldata를 받습니다
        // 데이터 반복 및 HTML 생성
        jdata=``;
        for (let k = 0; k < data.length && k < 8; k++) { // 최대 8개 또는 data.length 만큼
            const festival = data[k];
            // 이미지 alt 속성 개선 및 태그 표시 로직 추가
            jdata += `<a href="/festivals/view/${festival.id}/"><div class="festCard"><img src="${festival.image}" alt="${festival.name} 축제 이미지"><p>${festival.name}</p></div></a>`;
        }
        jdata += `</div>`; // recommendFestList 닫기

        $('.recommendFestList').html(jdata);
    }

    function createBtn() { console.log('Create Button clicked'); }
    function likeBtn() { console.log('Like Button clicked'); }
    function shareBtn() { console.log('Share Button clicked'); }
    function reviewBtn() { console.log('Review Button clicked'); }
    function viewBtn() { console.log('View Button clicked'); }
</script>
</head>

<body>
  <div id="wrap">
    <div id="nav">
      
      <div id="logo">
        <a href="/"><img id="logo_img" src="/static/image/logo_transparent_cut.png" alt="Logo" ></a>
        {% if user_id %}
        <span>for　<span><a href="/accounts/mypage1/">{{ nickname }}</a></span></span>
        {% endif %}
      </div>

      <div id="searchAll">
        <form action="fest_list.html" method="GET">
          <div class="searchKey">
            <input name="keyWord" type="text" placeholder="축제명, 지역, 태그 등으로 검색" />
            <button type="submit">검색</button>
          </div>
        </form>
      </div>

      <div id="pageMove">     
        <ul>
          <li><a href="/festivals/list/">festivals</a></li>
          {% if user_id %}
              <li><a href="/accounts/logout/">logout</a></li>
              <li><a href="/accounts/mypage1/">my page</a></li>
          {% else %}
              <li><a href="/accounts/login/">login</a></li>
              <li><a href="/accounts/signup/terms/">sign up</a></li>
          {% endif %}
          <li><a href="/inquiry/support/">support</a></li>  
        </ul>
      </div>

    </div>

    <div class="contents">
      
  </div>

  {% include "footer.html" %}


  {% comment %} <div id="footer">
    <h4>© 2025 FastFest | 사이트 개발자 정보</h4>
    <ul class="footer-links">
      <li><a href="#">개인정보처리방침</a></li>
      <li><a href="#">이용약관</a></li>
      <li><a href="#">관리자페이지 이동</a></li>
      <li>
        <div id="ldMode">
          <button type="button" class="ldBtn" onclick="ldBtn()">다크모드</button>
        </div>
      </li>
    </ul>
  </div>  {% endcomment %}
</body>
  <script>
    function logoBtn() {
      alert('go home');
    }

    function viewBtn() {
      alert('로그인 후 이용 가능');
    }

    function reviewBtn() {
      alert('로그인 후 이용 가능');
    }

    function shareBtn() {
      alert('로그인 후 이용 가능');
    }

    function likeBtn() {
      alert('로그인 후 이용 가능');
    }

    function createBtn() {
      location.href='/shortforms/upload/';
    }

    //JS: body.dark 클래스를 토글
    function ldBtn() {
    document.body.classList.toggle('dark');
    // (선택) 로컬 스토리지에 상태 저장
    const isDark = document.body.classList.contains('dark');
    localStorage.setItem('darkMode', isDark);
    }
  </script>